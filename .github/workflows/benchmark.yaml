name: Benchmark

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Language to benchmark'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - go
          - rust
          - zig
      os:
        description: 'Operating system'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu
          - macos

permissions:
  contents: read

jobs:
  benchmark-go:
    if: inputs.language == 'all' || inputs.language == 'go'
    strategy:
      matrix:
        os: ${{ inputs.os == 'all' && fromJSON('["ubuntu-latest", "macos-latest"]') || (inputs.os == 'ubuntu' && fromJSON('["ubuntu-latest"]') || fromJSON('["macos-latest"]')) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run Go benchmarks
        working-directory: go
        run: |
          echo "=== Go Noise Protocol Benchmarks (${{ runner.os }}) ==="
          echo ""
          echo "--- Basic Benchmarks ---"
          go test -bench='Benchmark(Key|DH|Hash|HKDF|Encrypt|Decrypt|Handshake|Transport)' -benchmem ./noise/...
          echo ""
          echo "--- Concurrent Benchmarks ---"
          go test -bench='BenchmarkConcurrent|BenchmarkSessionManager' -benchmem ./noise/...

      - name: Save results
        run: |
          mkdir -p results
          go test -bench=. -benchmem ./go/noise/... 2>&1 | tee results/benchmark-go-${{ runner.os }}.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-go-${{ runner.os }}
          path: results/benchmark-go-${{ runner.os }}.txt

  benchmark-rust:
    if: inputs.language == 'all' || inputs.language == 'rust'
    strategy:
      matrix:
        os: ${{ inputs.os == 'all' && fromJSON('["ubuntu-latest", "macos-latest"]') || (inputs.os == 'ubuntu' && fromJSON('["ubuntu-latest"]') || fromJSON('["macos-latest"]')) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust -> target

      - name: Run Rust benchmarks
        working-directory: rust
        run: |
          echo "=== Rust Noise Protocol Benchmarks (${{ runner.os }}) ==="
          echo ""
          echo "--- Basic Benchmarks ---"
          cargo bench -- 'key_generation|dh|hash|encrypt|decrypt|handshake|transport' 2>&1 | grep -E '(Benchmarking|time:|thrpt:)'
          echo ""
          echo "--- Concurrent Benchmarks ---"
          cargo bench -- 'concurrent|session_manager' 2>&1 | grep -E '(Benchmarking|time:|thrpt:)'

      - name: Save results
        working-directory: rust
        run: |
          mkdir -p ../results
          cargo bench 2>&1 | tee ../results/benchmark-rust-${{ runner.os }}.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-rust-${{ runner.os }}
          path: results/benchmark-rust-${{ runner.os }}.txt

  benchmark-zig:
    if: inputs.language == 'all' || inputs.language == 'zig'
    strategy:
      matrix:
        os: ${{ inputs.os == 'all' && fromJSON('["ubuntu-latest", "macos-latest"]') || (inputs.os == 'ubuntu' && fromJSON('["ubuntu-latest"]') || fromJSON('["macos-latest"]')) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install OpenSSL (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libssl-dev

      - name: Run Zig benchmarks
        working-directory: zig
        run: |
          echo "=== Zig Noise Protocol Benchmarks (${{ runner.os }}) ==="
          mkdir -p ../results
          
          # Set OpenSSL paths based on OS
          if [ "${{ runner.os }}" = "Linux" ]; then
            export CRYPTO_INCLUDE=/usr/include
            export CRYPTO_LIB=/usr/lib/x86_64-linux-gnu
            export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
          else
            export CRYPTO_INCLUDE=/opt/homebrew/opt/openssl@3/include
            export CRYPTO_LIB=/opt/homebrew/opt/openssl@3/lib
            export DYLD_LIBRARY_PATH=/opt/homebrew/opt/openssl@3/lib:$DYLD_LIBRARY_PATH
          fi
          
          # Run with system crypto backend for best performance
          zig build bench -Dbackend=system 2>&1 | tee ../results/benchmark-zig-${{ runner.os }}.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-zig-${{ runner.os }}
          path: results/benchmark-zig-${{ runner.os }}.txt
          if-no-files-found: ignore

  summary:
    needs: [benchmark-go, benchmark-rust, benchmark-zig]
    if: always() && (inputs.language == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate summary
        run: |
          echo "# Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Language: ${{ inputs.language }}" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ${{ inputs.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for os in Linux macOS; do
            echo "## $os" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            for lang in go rust zig; do
              file="results/benchmark-$lang-$os/benchmark-$lang-$os.txt"
              if [ -f "$file" ]; then
                echo "### $lang" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                cat "$file" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done
