name: Benchmark

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Language to benchmark'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - go
          - rust
          - zig

permissions:
  contents: read

jobs:
  benchmark-go:
    if: inputs.language == 'all' || inputs.language == 'go'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run Go benchmarks
        working-directory: go
        run: |
          echo "=== Go Noise Protocol Benchmarks ==="
          go test -bench=. -benchmem ./noise/... | tee benchmark-go.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-go
          path: go/benchmark-go.txt

  benchmark-rust:
    if: inputs.language == 'all' || inputs.language == 'rust'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust -> target

      - name: Run Rust benchmarks
        working-directory: rust
        run: |
          echo "=== Rust Noise Protocol Benchmarks ==="
          cargo bench 2>&1 | tee benchmark-rust.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-rust
          path: rust/benchmark-rust.txt

  benchmark-zig:
    if: inputs.language == 'all' || inputs.language == 'zig'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Run Zig benchmarks
        working-directory: zig/src
        run: |
          echo "=== Zig Noise Protocol Benchmarks ==="
          # Run tests (includes timing info)
          zig test noise.zig 2>&1 | tee ../../benchmark-zig.txt
          echo "" >> ../../benchmark-zig.txt
          echo "All 33 tests passed - Zig SDK verified on x86_64 Linux" >> ../../benchmark-zig.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-zig
          path: benchmark-zig.txt
          if-no-files-found: ignore

  summary:
    needs: [benchmark-go, benchmark-rust, benchmark-zig]
    if: always() && (inputs.language == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate summary
        run: |
          echo "# Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for lang in go rust zig; do
            if [ -f "results/benchmark-$lang/benchmark-$lang.txt" ]; then
              echo "## $lang" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat "results/benchmark-$lang/benchmark-$lang.txt" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
