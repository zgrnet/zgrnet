# 架构设计

## 核心概念

### ZigNet

全球的、基于公钥身份的网络层。所有 ZigNet 节点理论上可以互联。公钥是唯一的全网身份标识。

### ziglan

ZigNet 上的一个"局域网"或组织网络。一个 ziglan 可以是公司网络、朋友圈、社区等。

- **入口点**：有公网可达的入口点（域名/IP）
- **设备发现**：帮助成员互相发现（类似目录服务）
- **中继服务**：帮助 NAT 穿透（中继加密包，不解密内容）
- **准入策略**：可以有自己的准入策略（白名单、Token 验证等）

一个节点可以同时加入多个 ziglan。ziglan 本身也是一个 ZigNet 节点，只是提供了额外的发现和中继服务。

### Host

运行 ZigNet 程序的设备。每个 Host 有唯一的公钥身份。Host 在本地创建一个虚拟网卡（utun/tun）。

### Peer

相对概念，指从某个 Host 角度看，其他可连接的节点。A 是 B 的 peer，B 也是 A 的 peer。

## 身份与地址

### 身份 (Identity)

身份 = 公钥（Ed25519/X25519 密钥对）

- **全网唯一**：不需要注册，用户自己生成
- **自主控制**：私钥控制身份，不是平台授予
- **链上集成**：公钥可同时作为 Solana 钱包地址，用于链上身份验证

### IP 地址 (IP Address)

IP 是本地概念，不是全网概念。

- **动态分配**：每个 Host 给连接的 peer 动态分配本地 IP
- **本地视图**：不同 Host 看到的同一个 peer 的 IP 可以不同
- **透明**：用户不需要关心 IP，只需要用 `{pubkey}.zignet` 访问

### 域名 (Domain)

`{pubkey}.zignet`

- 由本地 Magic DNS 解析为动态分配的本地 IP
- 用户通过域名访问 peer，无需记忆 IP

## 网络模型

```
┌─────────────────────────────────────────────┐
│                  Application                │
│           (Connect to abc123.zignet)        │
└──────────────────────┬──────────────────────┘
                       │
┌──────────────────────▼──────────────────────┐
│                Magic DNS                    │
│        (Resolve abc123.zignet -> 10.0.0.2)  │
└──────────────────────┬──────────────────────┘
                       │
┌──────────────────────▼──────────────────────┐
│               Host OS (TUN)                 │
│          (IP Packet: Src=Self, Dst=Peer)    │
└──────────────────────┬──────────────────────┘
                       │
┌──────────────────────▼──────────────────────┐
│                ZigNet Program               │
│      (Map 10.0.0.2 -> Pubkey abc123...)     │
│      (Encrypt with Noise Protocol)          │
└──────────────────────┬──────────────────────┘
                       │
┌──────────────────────▼──────────────────────┐
│               Transport Layer               │
│          (UDP / TCP / Relay / Obfuscation)  │
└─────────────────────────────────────────────┘
```

