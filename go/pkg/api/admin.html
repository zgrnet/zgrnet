<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>zgrnet admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#c9d1d9;--text2:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--font:system-ui,-apple-system,sans-serif;--mono:ui-monospace,SFMono-Regular,monospace}
body{font-family:var(--font);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
a{color:var(--accent);text-decoration:none}
h2{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--text)}
.container{max-width:960px;margin:0 auto;padding:16px}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:16px}
header h1{font-size:18px;font-weight:600}
header .pubkey{font-family:var(--mono);font-size:12px;color:var(--text2)}
nav{display:flex;gap:4px;background:var(--surface);border-bottom:1px solid var(--border);padding:0 16px;overflow-x:auto}
nav button{background:none;border:none;color:var(--text2);padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:2px solid transparent;white-space:nowrap}
nav button:hover{color:var(--text)}
nav button.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel{display:none;padding:20px 0}
.panel.active{display:block}
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:12px}
.card h3{font-size:14px;margin-bottom:8px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px}
.stat .label{font-size:12px;color:var(--text2)}
.stat .value{font-size:24px;font-weight:600;font-family:var(--mono)}
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:8px 12px;border-bottom:1px solid var(--border)}
th{font-size:12px;color:var(--text2);font-weight:500;text-transform:uppercase}
td{font-size:13px}
.mono{font-family:var(--mono);font-size:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
.badge-green{background:#23842740;color:var(--green)}
.badge-red{background:#f8514940;color:var(--red)}
.badge-yellow{background:#d2992240;color:var(--yellow)}
.badge-gray{background:#30363d;color:var(--text2)}
.toolbar{display:flex;gap:8px;margin-bottom:12px}
.btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px}
.btn:hover{background:var(--border)}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn-primary:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff;border-color:var(--red)}
.btn-danger:hover{opacity:.9}
input,select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:13px;font-family:var(--font)}
input:focus{outline:none;border-color:var(--accent)}
.form-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.form-row label{min-width:80px;font-size:12px;color:var(--text2)}
.form-row input{flex:1}
.empty{color:var(--text2);font-style:italic;padding:20px;text-align:center}
.hidden{display:none}
dialog{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;color:var(--text);max-width:480px;width:90%}
dialog::backdrop{background:rgba(0,0,0,.6)}
dialog h3{margin-bottom:16px}
dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
pre{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px;font-family:var(--mono);font-size:12px;overflow-x:auto;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <h1>zgrnet</h1>
  <span class="pubkey" id="hdr-pubkey">loading...</span>
  <span style="margin-left:auto;color:var(--text2)" id="hdr-uptime"></span>
</header>

<nav id="nav">
  <button data-panel="overview" class="active">Overview</button>
  <button data-panel="peers">Peers</button>
  <button data-panel="lans">Lans</button>
  <button data-panel="policy">Policy</button>
  <button data-panel="routes">Routes</button>
  <button data-panel="dns">DNS</button>
  <button data-panel="proxy">Proxy</button>
</nav>

<div class="container">

<!-- Overview -->
<div class="panel active" id="panel-overview">
  <div class="stat-grid" id="overview-stats"></div>
  <div class="card" style="margin-top:16px">
    <h3>Network Config</h3>
    <pre id="net-config">loading...</pre>
  </div>
</div>

<!-- Peers -->
<div class="panel" id="panel-peers">
  <div class="toolbar">
    <button class="btn btn-primary" onclick="showAddPeer()">Add Peer</button>
    <button class="btn" onclick="loadPeers()">Refresh</button>
  </div>
  <table><thead><tr><th>Alias</th><th>Public Key</th><th>TUN IP</th><th>State</th><th>Traffic</th><th></th></tr></thead>
  <tbody id="peers-body"></tbody></table>
</div>

<!-- Lans -->
<div class="panel" id="panel-lans">
  <div class="toolbar">
    <button class="btn btn-primary" onclick="showAddLan()">Join Lan</button>
    <button class="btn" onclick="loadLans()">Refresh</button>
  </div>
  <table><thead><tr><th>Domain</th><th>Pubkey</th><th>Endpoint</th><th></th></tr></thead>
  <tbody id="lans-body"></tbody></table>
</div>

<!-- Policy -->
<div class="panel" id="panel-policy">
  <div class="toolbar">
    <button class="btn btn-primary" onclick="showAddRule()">Add Rule</button>
    <button class="btn" onclick="loadPolicy()">Refresh</button>
  </div>
  <div id="policy-default"></div>
  <table><thead><tr><th>Name</th><th>Match</th><th>Services</th><th>Action</th><th></th></tr></thead>
  <tbody id="policy-body"></tbody></table>
</div>

<!-- Routes -->
<div class="panel" id="panel-routes">
  <div class="toolbar">
    <button class="btn btn-primary" onclick="showAddRoute()">Add Route</button>
    <button class="btn" onclick="loadRoutes()">Refresh</button>
  </div>
  <table><thead><tr><th>#</th><th>Domain</th><th>Peer</th><th></th></tr></thead>
  <tbody id="routes-body"></tbody></table>
</div>

<!-- DNS -->
<div class="panel" id="panel-dns">
  <div class="toolbar"><button class="btn" onclick="loadDns()">Refresh</button></div>
  <div class="stat-grid" id="dns-stats"></div>
</div>

<!-- Proxy -->
<div class="panel" id="panel-proxy">
  <div class="toolbar"><button class="btn" onclick="loadProxy()">Refresh</button></div>
  <div class="stat-grid" id="proxy-stats"></div>
</div>

</div><!-- container -->

<!-- Dialogs -->
<dialog id="dlg-peer">
  <h3>Add Peer</h3>
  <div class="form-row"><label>Public Key</label><input id="peer-pk" placeholder="64-char hex"></div>
  <div class="form-row"><label>Alias</label><input id="peer-alias" placeholder="optional"></div>
  <div class="form-row"><label>Endpoint</label><input id="peer-ep" placeholder="host:port"></div>
  <div class="actions"><button class="btn" onclick="this.closest('dialog').close()">Cancel</button><button class="btn btn-primary" onclick="addPeer()">Add</button></div>
</dialog>

<dialog id="dlg-lan">
  <h3>Join Lan</h3>
  <div class="form-row"><label>Domain</label><input id="lan-domain" placeholder="company.zigor.net"></div>
  <div class="form-row"><label>Pubkey</label><input id="lan-pk" placeholder="64-char hex"></div>
  <div class="form-row"><label>Endpoint</label><input id="lan-ep" placeholder="host:port"></div>
  <div class="actions"><button class="btn" onclick="this.closest('dialog').close()">Cancel</button><button class="btn btn-primary" onclick="joinLan()">Join</button></div>
</dialog>

<dialog id="dlg-rule">
  <h3>Add Policy Rule</h3>
  <div class="form-row"><label>Name</label><input id="rule-name"></div>
  <div class="form-row"><label>Match Type</label><select id="rule-type"><option>any</option><option>whitelist</option><option>zgrlan</option></select></div>
  <div class="form-row"><label>Action</label><select id="rule-action"><option>allow</option><option>deny</option></select></div>
  <div class="actions"><button class="btn" onclick="this.closest('dialog').close()">Cancel</button><button class="btn btn-primary" onclick="addRule()">Add</button></div>
</dialog>

<dialog id="dlg-route">
  <h3>Add Route</h3>
  <div class="form-row"><label>Domain</label><input id="route-domain" placeholder="*.google.com"></div>
  <div class="form-row"><label>Peer</label><input id="route-peer" placeholder="peer alias"></div>
  <div class="actions"><button class="btn" onclick="this.closest('dialog').close()">Cancel</button><button class="btn btn-primary" onclick="addRoute()">Add</button></div>
</dialog>

<script>
const API='';
async function api(method,path,body){
  const opts={method,headers:{'Content-Type':'application/json'}};
  if(body)opts.body=JSON.stringify(body);
  const r=await fetch(API+path,opts);
  if(r.status===204)return null;
  const text=await r.text();
  try{return JSON.parse(text)}catch{return text}
}

// Nav
document.getElementById('nav').addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON')return;
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById('panel-'+e.target.dataset.panel).classList.add('active');
  const loaders={overview:loadOverview,peers:loadPeers,lans:loadLans,policy:loadPolicy,routes:loadRoutes,dns:loadDns,proxy:loadProxy};
  (loaders[e.target.dataset.panel]||function(){})();
});

function stat(label,value){return `<div class="stat"><div class="label">${label}</div><div class="value">${value}</div></div>`}
function badge(state){const m={established:'green',new:'gray',connecting:'yellow',failed:'red'};return `<span class="badge badge-${m[state]||'gray'}">${state}</span>`}
function fmtBytes(n){if(!n)return '0 B';const u=['B','KB','MB','GB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(i?1:0)+' '+u[i]}
function short(s){return s?s.substring(0,16)+'â€¦':''}

// Overview
async function loadOverview(){
  const w=await api('GET','/api/whoami');
  document.getElementById('hdr-pubkey').textContent=short(w.pubkey);
  document.getElementById('hdr-uptime').textContent='up '+w.uptime;
  const net=await api('GET','/api/config/net');
  document.getElementById('net-config').textContent=JSON.stringify(net,null,2);
  const peers=await api('GET','/api/peers');
  const online=Array.isArray(peers)?peers.filter(p=>p.state==='established').length:0;
  const total=Array.isArray(peers)?peers.length:0;
  document.getElementById('overview-stats').innerHTML=
    stat('Public Key','<span class="mono" style="font-size:12px">'+short(w.pubkey)+'</span>')+
    stat('TUN IP',w.tun_ip)+
    stat('Peers',total)+
    stat('Online',online)+
    stat('Uptime',w.uptime);
}

// Peers
async function loadPeers(){
  const peers=await api('GET','/api/peers');
  const tb=document.getElementById('peers-body');
  if(!Array.isArray(peers)||!peers.length){tb.innerHTML='<tr><td colspan="6" class="empty">No peers</td></tr>';return}
  tb.innerHTML=peers.map(p=>`<tr>
    <td>${p.alias||'-'}</td>
    <td class="mono">${short(p.pubkey)}</td>
    <td class="mono">${p.tun_ip||'-'}</td>
    <td>${badge(p.state||'new')}</td>
    <td>${fmtBytes(p.rx_bytes)} / ${fmtBytes(p.tx_bytes)}</td>
    <td><button class="btn btn-danger" onclick="removePeer('${p.pubkey}')">Remove</button></td>
  </tr>`).join('');
}
function showAddPeer(){document.getElementById('dlg-peer').showModal()}
async function addPeer(){
  const pk=document.getElementById('peer-pk').value.trim();
  if(!pk){alert('Public key required');return}
  await api('POST','/api/peers',{pubkey:pk,alias:document.getElementById('peer-alias').value.trim(),endpoint:document.getElementById('peer-ep').value.trim()});
  document.getElementById('dlg-peer').close();
  loadPeers();
}
async function removePeer(pk){if(confirm('Remove peer?')){await api('DELETE','/api/peers/'+pk);loadPeers()}}

// Lans
async function loadLans(){
  const lans=await api('GET','/api/lans');
  const tb=document.getElementById('lans-body');
  if(!Array.isArray(lans)||!lans.length){tb.innerHTML='<tr><td colspan="4" class="empty">No lans</td></tr>';return}
  tb.innerHTML=lans.map(l=>`<tr>
    <td>${l.domain}</td>
    <td class="mono">${short(l.pubkey)}</td>
    <td class="mono">${l.endpoint}</td>
    <td><button class="btn btn-danger" onclick="leaveLan('${l.domain}')">Leave</button></td>
  </tr>`).join('');
}
function showAddLan(){document.getElementById('dlg-lan').showModal()}
async function joinLan(){
  const d=document.getElementById('lan-domain').value.trim();
  const pk=document.getElementById('lan-pk').value.trim();
  const ep=document.getElementById('lan-ep').value.trim();
  if(!d||!pk||!ep){alert('All fields required');return}
  await api('POST','/api/lans',{domain:d,pubkey:pk,endpoint:ep});
  document.getElementById('dlg-lan').close();
  loadLans();
}
async function leaveLan(d){if(confirm('Leave lan?')){await api('DELETE','/api/lans/'+d);loadLans()}}

// Policy
async function loadPolicy(){
  const p=await api('GET','/api/policy');
  document.getElementById('policy-default').innerHTML=p.default?`<div class="card"><b>Default:</b> ${p.default}</div>`:'';
  const tb=document.getElementById('policy-body');
  const rules=p.rules||[];
  if(!rules.length){tb.innerHTML='<tr><td colspan="5" class="empty">No rules</td></tr>';return}
  tb.innerHTML=rules.map(r=>`<tr>
    <td>${r.name}</td>
    <td>${r.match?.pubkey?.type||'-'}</td>
    <td>${(r.services||[]).map(s=>s.proto+':'+s.port).join(', ')||'*'}</td>
    <td>${badge(r.action==='allow'?'established':'failed')}</td>
    <td><button class="btn btn-danger" onclick="removeRule('${r.name}')">Remove</button></td>
  </tr>`).join('');
}
function showAddRule(){document.getElementById('dlg-rule').showModal()}
async function addRule(){
  const name=document.getElementById('rule-name').value.trim();
  if(!name){alert('Name required');return}
  await api('POST','/api/policy/rules',{name,match:{pubkey:{type:document.getElementById('rule-type').value}},services:[{proto:'*',port:'*'}],action:document.getElementById('rule-action').value});
  document.getElementById('dlg-rule').close();
  loadPolicy();
}
async function removeRule(n){if(confirm('Remove rule?')){await api('DELETE','/api/policy/rules/'+n);loadPolicy()}}

// Routes
async function loadRoutes(){
  const routes=await api('GET','/api/routes');
  const tb=document.getElementById('routes-body');
  if(!Array.isArray(routes)||!routes.length){tb.innerHTML='<tr><td colspan="4" class="empty">No routes</td></tr>';return}
  tb.innerHTML=routes.map((r,i)=>`<tr>
    <td>${i}</td>
    <td class="mono">${r.domain||r.domain_list||'-'}</td>
    <td>${r.peer}</td>
    <td><button class="btn btn-danger" onclick="removeRoute(${i})">Remove</button></td>
  </tr>`).join('');
}
function showAddRoute(){document.getElementById('dlg-route').showModal()}
async function addRoute(){
  const d=document.getElementById('route-domain').value.trim();
  const p=document.getElementById('route-peer').value.trim();
  if(!d||!p){alert('All fields required');return}
  await api('POST','/api/routes',{domain:d,peer:p});
  document.getElementById('dlg-route').close();
  loadRoutes();
}
async function removeRoute(i){if(confirm('Remove route?')){await api('DELETE','/api/routes/'+i);loadRoutes()}}

// DNS stats
async function loadDns(){
  const s=await api('GET','/api/dns/stats');
  document.getElementById('dns-stats').innerHTML=
    stat('Total Queries',s.total_queries||0)+
    stat('zigor.net Hits',s.zigor_net_hits||0)+
    stat('Fake IP Hits',s.fake_ip_hits||0)+
    stat('Upstream Fwds',s.upstream_forwards||0)+
    stat('Upstream Errors',s.upstream_errors||0)+
    stat('Errors',s.errors||0);
}

// Proxy stats
async function loadProxy(){
  const s=await api('GET','/api/proxy/stats');
  document.getElementById('proxy-stats').innerHTML=
    stat('Total Connections',s.total_connections||0)+
    stat('Active',s.active_connections||0)+
    stat('Bytes Sent',fmtBytes(s.bytes_sent||0))+
    stat('Bytes Received',fmtBytes(s.bytes_received||0))+
    stat('Errors',s.errors||0);
}

// Init
loadOverview();
</script>
</body>
</html>
